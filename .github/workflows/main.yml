name: Android tests

on:
  push:
    branches:
      - master
      
jobs:
  # build:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v2
        
  #     - uses: actions/cache@v2
  #       with:
  #         path: |
  #           ~/.gradle/caches/modules-*
  #           ~/.gradle/caches/jars-*
  #           ~/.gradle/caches/build-cache-*
  #         key: gradle-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}-${{ hashFiles('**/buildSrc/**/*.kt') }}
  #         restore-keys: gradle-
      
  #     - name: Build project
  #       working-directory: ${{ env.SAMPLE_PATH }}
  #       run: ./gradlew app:assembleDebug

  instrumented-tests:
    name: Instrumented tests
    runs-on: macos-latest
    timeout-minutes: 25
    strategy:
      matrix:
        api-level: [28]
        shard-index: [ 0 ]
        shard-num: [ 1 ]

    env:
      JAVA_TOOL_OPTIONS: -Xmx4g
      ENABLE_APP_VERSIONING: false

    steps:
      - uses: actions/checkout@v2

      - uses: gradle/wrapper-validation-action@v1

      - uses: actions/setup-java@v1
        with:
          java-version: 15

      - uses: actions/cache@v2
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}-${{ hashFiles('**/buildSrc/**/*.kt') }}
          restore-keys: |
            gradle-
      - name: Run Android instrumented tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 28
          arch: x86_64
          profile: Nexus 5X
          script: ./gradlew connectedCheck
#   test:
#     needs: build
#     runs-on: macOS-latest # enables hardware acceleration in the virtual machine
#     timeout-minutes: 30
#     strategy:
#       matrix:
#         api-level: [29]
#         flavor: [ Google ]
#         shard-index: [ 0 ]
#         shard-num: [ 1 ]

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v2
          
#       - uses: actions/cache@v2
#         with:
#           path: |
#             ~/.gradle/caches/modules-*
#             ~/.gradle/caches/jars-*
#             ~/.gradle/caches/build-cache-*
#           key: gradle-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}
#           restore-keys: gradle-

#       - name: Run instrumentation tests
#         uses: AfzalivE/action-simple-android-emulator@v1
# #         uses: reactivecircus/android-emulator-runner@v2.14.3
# #         with:
# #           api-level: ${{ matrix.api-level }}
# #           arch: x86
# #           target: playstore
# #           disable-animations: true
# #           script: > 
# #             ./gradlew app:connectedDebugAndroidTest 
# #             -Pandroid.testInstrumentationRunnerArguments.numShards=${{ matrix.shard-num }} 
# #             -Pandroid.testInstrumentationRunnerArguments.shardIndex=${{ matrix.shard-index }}
#       - name: Upload test reports
#         if: always()
#         uses: actions/upload-artifact@v2
#         with:
#           name: test-reports
#           path: app/build/reports
